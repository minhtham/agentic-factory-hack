using System;
using System.Text.Json;
using System.Text.Json.Serialization;
using System.Threading.Tasks;
using Azure.AI.Projects;
using Azure.Identity;
using Microsoft.Extensions.Logging;
using RepairPlanner.Models;
using RepairPlanner.Services;
using RepairPlanner;

// Prefer Foundry project endpoint, fall back to chat endpoint for environments that use the chat-style URL
var endpoint = Environment.GetEnvironmentVariable("AZURE_AI_PROJECT_ENDPOINT")
		   ?? Environment.GetEnvironmentVariable("AZURE_AI_CHAT_ENDPOINT")
		   ?? throw new InvalidOperationException("AZURE_AI_PROJECT_ENDPOINT or AZURE_AI_CHAT_ENDPOINT is required");

// Model deployment name fallback chain: explicit MODEL_DEPLOYMENT_NAME, chat-specific, or default
var modelDeployment = Environment.GetEnvironmentVariable("MODEL_DEPLOYMENT_NAME")
				   ?? Environment.GetEnvironmentVariable("AZURE_AI_CHAT_MODEL_DEPLOYMENT_NAME")
				   ?? Environment.GetEnvironmentVariable("AZURE_AI_MODEL_DEPLOYMENT_NAME")
				   ?? "gpt-4o";

var cosmosEndpoint = Environment.GetEnvironmentVariable("COSMOS_ENDPOINT") ?? "http://localhost:8081";
var cosmosKey = Environment.GetEnvironmentVariable("COSMOS_KEY") ?? "C2y6yDjf5/R+ob0N8A7Cgv30VR...";
var cosmosDbName = Environment.GetEnvironmentVariable("COSMOS_DATABASE_NAME") ?? "RepairPlannerDb";

var loggerFactory = LoggerFactory.Create(builder => builder.AddSimpleConsole(options => { options.IncludeScopes = false; }));
var logger = loggerFactory.CreateLogger<RepairPlannerAgent>();

var projectClient = new AIProjectClient(new Uri(endpoint), new DefaultAzureCredential());

var cosmosOptions = new CosmosDbOptions { Endpoint = cosmosEndpoint, Key = cosmosKey, DatabaseName = cosmosDbName };
var cosmosLogger = loggerFactory.CreateLogger<RepairPlanner.Services.CosmosDbService>();
await using var cosmosDb = new CosmosDbService(cosmosOptions, cosmosLogger);

IFaultMappingService faultMapping = new FaultMappingService();

var agent = new RepairPlannerAgent(projectClient, cosmosDb, faultMapping, modelDeployment, logger);

// Sample diagnosed fault
var sampleFault = new DiagnosedFault
{
	Id = Guid.NewGuid().ToString(),
	FaultType = "curing_temperature_excessive",
	MachineId = "MACHINE-123",
	Severity = "high",
	Confidence = 0.92,
	Timestamp = DateTime.UtcNow,
	Notes = "Sample fault generated by Program.cs",
};

try
{
	var wo = await agent.PlanAndCreateWorkOrderAsync(sampleFault);
	var jsonOptions = new JsonSerializerOptions { WriteIndented = true, PropertyNameCaseInsensitive = true };
	jsonOptions.NumberHandling = JsonNumberHandling.AllowReadingFromString;
	var programLogger = loggerFactory.CreateLogger("Program");
	programLogger.LogInformation("Saved work order {WorkOrderNumber} (id={Id}, status={Status}, assignedTo={AssignedTo})", wo.WorkOrderNumber, wo.Id, wo.Status, wo.AssignedTo);
	Console.WriteLine("Created WorkOrder:\n");
	Console.WriteLine(JsonSerializer.Serialize(wo, jsonOptions));
}
catch (Exception ex)
{
	Console.WriteLine($"Error running RepairPlannerAgent: {ex.Message}");
}

